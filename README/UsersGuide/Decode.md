<!-- Decode.md --- 
;; 
;; Description: 
;; Author: Hongyi Wu(吴鸿毅)
;; Email: wuhongyi@qq.com 
;; Created: 日 5月 13 20:23:14 2018 (+0800)
;; Last-Updated: 日 10月  7 08:11:48 2018 (+0800)
;;           By: Hongyi Wu(吴鸿毅)
;;     Update #: 10
;; URL: http://wuhongyi.cn -->

# Decode

**The Decode program is used to convert data collected by different capture cards in the same run into a ROOT file. The user's physical analysis is based on the ROOT file generated by the program.**

**Decode 程序用来将同一轮数据不同采集卡采集的数据转为一个 ROOT 文件。用户的物理分析以本程序产生的 ROOT 文件为基准。**

The user first needs to modify the definition in the **UesrDefine.hh** file.  
用户首先需要修改 **UesrDefine.hh** 文件中的定义

```cpp
#define ROOTFILEPATH "/home/wuhongyi/data/"  //The path to generate the ROOT file  要生成ROOT文件的路径
#define RAWFILEPATH "/home/wuhongyi/data/"   //The path of the original binary  原始二进制文件的路径
#define RAWFILENAME "data"                   //The filename of the original binary 原始文件的文件名


#define Crate0
#define Crate0num 5   //Number of plugins used in this chassis 该机箱中使用插件数
const int Crate0SamplingRate[Crate0num] = {100,100,100,250,250};//Specify the sampling rate for each plugin separately, 100/250/500 three sampling rates, 0 means skipping the plugin.  分别指定每个插件的采样率  100/250/500三种采样率  0为跳过该插件
```

Users need to modify the following concents:
   -  The directory where the original binary files are stored.
   -  The directory where the generated ROOT files are stored.
   - File name.
   - Number of capture cards used in the chassis.
   - The sampling frequency corresponding to each acquisition card. If the sampling frequency is set to 0, the data of the acquisition card is ignored.
   
用户需要修改：
- 原始二进制文件存放目录
- 生成 ROOT 文件存放目录
- 文件名
- 机箱中使用采集卡个数
- 每个采集卡对应的采样频率，如果采样频率设置为0，则忽略该采集卡的数据


After modifying, execute the following command to compile the program:  
修改之后执行以下命令编译程序：

```bash
make clean
make
```

After the compilation is successful, an executable file decode will be generated, and the program will run as follows:  
编译成功之后将生成一个可执行文件 **decode**，程序运行方式：

```bash
./decode [RuNnumber]
```
[RuNnumber] is the file run number you want to convert.  
其中 *[RuNnumber]* 为想要转换的文件运行编号。


For example: / 例如：
```bash
./decade  3
```

----

**ROOT File Branch：**




- sr(short): sample rate，100/250/500，This value is specified in UesrDefine.hh. / 该数值由 UesrDefine.hh 中指定
- pileup(bool): pile-up flag / 堆积标记。
- outofr(bool): the overrange flag / 是否超量程标记。
- cid(short): chassis number / 机箱编号
- sid(short): slot number / 采集卡所在插槽编号
- ch(short): channel number / 采集卡通道
- evte(unsigned short): energy / 梯形算法的能量
- ts(long int 64 bit): timestamps / 时间戳
- ets(long int 64 bit): external timestamps / 外部时间戳
- cfd(short): cfd value / cfd数值
- cfdft(bool): Is the cfd value valid? yes or no / cfd数值是否有效
- cfds(short):cfd source，only for 250/500 MHz modules / 仅适用于 250/500 MHz 采集卡
- trae(unsigned int): energy trapezoidal rising segment integral / 能量梯形上升段积分
- leae(unsigned int): energy trapezoidal falling segment integral / 能量梯形下降段积分
- gape(unsigned int): energy trapezoidal gaps segment integral / 能量梯形平台段积分
- base(double):the baseline of the energy trapezoidal algorithm / 能量梯形算法的基线
- qs(unsigned int): the integral of eight QDC areas / 八个QDC面积的积分
- ltra(unsigned short): umber of waveform acquisition points / 波形采集点数
- data(unsigned short): waveform data / 波形数据
- dt(unsigned short): In order to view each waveform directly, an array of values from 0 - N-1 is added / 为了方便直接查看每个波形，添加了一个数值从0 - N-1 的数组
- nevt(unsigned int): the number of this event in this ROOT file / 该事件在本文件中的编号

The following figure shows the Branch definition in a file:  
下图展示一个文件中的 Branch 定义：   
![File Branch 1](/img/ROOTFILEBRANCH_1.png)
![File Branch 2](/img/ROOTFILEBRANCH_2.png)



----

At the end of each run of data conversion, a **txt** file will be generated in this folder, which counts the following information for each channel of the modules:
- Mod: Module number, starting from 0.
- Channel: Channel marker, 0 - 15.
- OutOfRange: Number of events whose signal amplitude exceeds the range of the analog-to-digital conversion module.
- Pileup: Number of events marked as pile-up.
- CfdForcedTrigger: Number of events forced by cfd (cfd does not exceeded threshold).
- Energy->0: Calculate the number of events with trapezoidal energy less than 0 (the result is less than 0 and is directly marked as 0).
- WaveformCount: Number of events recording the waveform.
- TotalEvent: Total number of output events.



每轮数据转换结束，本文件夹内均会生成一个 **txt** 文件，该文件统计了采集卡每个通道的以下信息：

- Mod: 采集卡标记，从0开始
- Channel: 采集卡通道标记，0 - 15
- OutOfRange: 信号幅度超出模数转换模块范围的事件数
- Pileup: 标记为堆积的事件数
- CfdForcedTrigger: cfd强制触发事件数（cfd未过阈值）
- Energy->0: 计算梯形能量小于 0 的事件数（计算结果小于 0 的直接被标记为0了）
- WaveformCount: 记录波形的事件数
- TotalEvent: 总的输出事件数



<!-- Decode.md ends here -->
